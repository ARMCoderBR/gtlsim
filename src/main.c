////////////////////////////////////////////////////////////////////////////////
// TLSIM
// A TINY LOGIC CIRCUIT SIMULATOR
// (C) 2019, 2020 BY ARMCODER - milton@armcoder.com.br
//
// THIS PROGRAM IS FREE SOFTWARE
// SEE LICENSE AT https://www.gnu.org/licenses/old-licenses/gpl-2.0.txt
////////////////////////////////////////////////////////////////////////////////

#include <stdio.h>
#include <ncurses.h>

#include "board.h"
#include "tests.h"
#include "computer.h"

#include <gtk/gtk.h>

int state = 1;

GtkImage * image1;
GtkWidget *main_grid;

////////////////////////////////////////////////////////////////////////////////
static void
print_hello (GtkWidget *widget,
             gpointer   comp) {

    g_print ("Hello World\n");
    computer_sim_run((computer_t*)comp);

    state ^= 1;

    if (state)
        gtk_image_set_from_file (image1,"../led-red-on.png");
    else
        gtk_image_set_from_file (image1,"../led-red-off.png");
}

unsigned char pixbuf_red_on[]={
        0x42,0x4d,0xf6,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x36,0x00,0x00,0x00,0x28,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x01,0x00,0x18,0x00,0x00,0x00,
        0x00,0x00,0xc0,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0xf0,0xf0,0xf9,0xf9,0xf9,0xf2,0xf2,0xf2,0xf2,
        0xf2,0xf2,0xa9,0xa9,0xa9,0x72,0x72,0x72,0x72,0x72,0x72,0x71,0x71,0x71,0x72,0x72,0x72,0x7f,0x7f,0x7f,0x7f,0x7f,0x7f,0x7b,0x7b,0x7b,0x79,0x79,0x79,0x75,0x75,0x75,
        0x73,0x73,0x73,0x71,0x71,0x71,0x72,0x72,0x72,0x71,0x71,0x71,0x72,0x72,0x72,0xa3,0xa3,0xa3,0xea,0xea,0xea,0xf7,0xf7,0xf7,0xf3,0xf3,0xf3,0xf9,0xf9,0xf9,0xfb,0xfb,
        0xfb,0xf3,0xf3,0xf3,0xec,0xec,0xec,0x8b,0x8b,0x8b,0x76,0x76,0x76,0x75,0x75,0x75,0x87,0x87,0x87,0x8a,0x8a,0x8a,0x82,0x82,0x90,0x6e,0x6f,0xb5,0x59,0x5b,0xcb,0x50,
        0x52,0xd7,0x4d,0x4f,0xd5,0x50,0x51,0xca,0x5c,0x5d,0xb1,0x69,0x6a,0x84,0x6c,0x6c,0x6c,0x6b,0x6b,0x6b,0x75,0x75,0x75,0x75,0x75,0x75,0x83,0x83,0x83,0xde,0xde,0xde,
        0xf9,0xf9,0xf9,0xf3,0xf3,0xf3,0xf0,0xf0,0xf0,0xec,0xec,0xec,0x85,0x85,0x85,0x79,0x79,0x79,0x78,0x78,0x78,0x91,0x91,0x91,0x86,0x87,0xa0,0x5a,0x5d,0xd8,0x15,0x24,
        0xfb,0x00,0x17,0xfe,0x00,0x16,0xfe,0x00,0x14,0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,0x04,0x10,0xfb,0x3e,0x40,0xd7,0x5e,0x5f,0x90,0x68,0x68,0x68,0x79,
        0x79,0x79,0x78,0x78,0x78,0x82,0x82,0x82,0xdc,0xdc,0xdc,0xf9,0xf9,0xf9,0xf3,0xf3,0xf3,0x91,0x91,0x91,0x7d,0x7d,0x7d,0x7b,0x7b,0x7b,0x93,0x94,0x94,0x78,0x7a,0xc1,
        0x1c,0x2c,0xf9,0x00,0x1c,0xfe,0x00,0x1b,0xfe,0x01,0x19,0xfe,0x00,0x17,0xfe,0x00,0x16,0xfd,0x00,0x14,0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,0x00,0x0d,
        0xfd,0x07,0x12,0xfa,0x49,0x4b,0xbd,0x66,0x65,0x66,0x80,0x80,0x80,0x7c,0x7c,0x7c,0x87,0x87,0x87,0xe9,0xe9,0xe9,0xb1,0xb1,0xb1,0x80,0x80,0x80,0x7f,0x7f,0x7f,0x98,
        0x98,0x98,0x72,0x77,0xd0,0x00,0x21,0xfe,0x00,0x20,0xfe,0x00,0x1f,0xfe,0x00,0x1c,0xfe,0x00,0x1b,0xfe,0x01,0x19,0xff,0x00,0x17,0xfe,0x00,0x16,0xfd,0x00,0x14,0xfd,
        0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,0x00,0x0d,0xfd,0x00,0x0c,0xfd,0x3e,0x40,0xce,0x63,0x63,0x64,0x80,0x80,0x80,0x80,0x80,0x80,0xa6,0xa6,0xa6,0x84,0x84,
        0x84,0x83,0x83,0x83,0x9c,0x9c,0x9c,0x81,0x84,0xc5,0x01,0x26,0xfd,0x00,0x23,0xfd,0x00,0x21,0xfe,0x00,0x20,0xfe,0x00,0x1f,0xfe,0x00,0x1c,0xfe,0x00,0x1b,0xfe,0x01,
        0x19,0xfe,0x00,0x17,0xfd,0x00,0x16,0xfd,0x00,0x14,0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,0x00,0x0d,0xfd,0x00,0x0c,0xfd,0x44,0x46,0xbf,0x61,0x61,0x61,
        0x84,0x84,0x84,0x83,0x83,0x83,0x87,0x87,0x87,0x98,0x98,0x98,0x99,0x9a,0xad,0x23,0x38,0xf8,0x00,0x28,0xfd,0x01,0x26,0xfe,0x00,0x23,0xfd,0x00,0x21,0xfe,0x00,0x20,
        0xfe,0x00,0x1e,0xfe,0x00,0x1c,0xfe,0x00,0x1b,0xfe,0x01,0x19,0xfe,0x00,0x18,0xfd,0x00,0x16,0xfd,0x00,0x14,0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,0x00,
        0x0d,0xfd,0x02,0x0e,0xfb,0x55,0x56,0x90,0x64,0x64,0x64,0x87,0x87,0x87,0x8a,0x8a,0x8a,0xa3,0xa3,0xa3,0x6e,0x74,0xdc,0x00,0x2b,0xfc,0x01,0x29,0xfd,0x00,0x28,0xfd,
        0x01,0x26,0xfe,0x00,0x23,0xfd,0x00,0x21,0xfe,0x03,0x22,0xfe,0x1f,0x30,0xfe,0x2c,0x39,0xfe,0x2c,0x38,0xfe,0x1f,0x2c,0xfd,0x03,0x1a,0xfd,0x00,0x16,0xfd,0x00,0x14,
        0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,0x00,0x0d,0xfd,0x30,0x33,0xdb,0x5f,0x5f,0x5f,0x8a,0x8a,0x8a,0x9a,0x9a,0x9a,0xa2,0xa3,0xaa,0x22,0x3c,0xf9,0x00,
        0x2d,0xfd,0x00,0x2b,0xfc,0x00,0x29,0xfd,0x00,0x28,0xfd,0x01,0x26,0xfd,0x1c,0x31,0xfd,0x2e,0x3d,0xfe,0x47,0x53,0xfd,0x4f,0x5d,0xfc,0x4f,0x5c,0xfc,0x47,0x53,0xfd,
        0x2e,0x3a,0xfd,0x1c,0x29,0xfd,0x00,0x16,0xfd,0x00,0x14,0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,0x01,0x0e,0xfc,0x58,0x59,0x84,0x8e,0x8e,0x8e,0x9d,0x9d,
        0x9d,0x92,0x95,0xc6,0x00,0x31,0xfd,0x00,0x2f,0xfd,0x00,0x2c,0xfd,0x00,0x2b,0xfc,0x01,0x29,0xfd,0x03,0x29,0xfd,0x2e,0x3f,0xfe,0x52,0x61,0xfc,0x62,0x71,0xfd,0x6a,
        0x79,0xfd,0x6a,0x79,0xfd,0x62,0x71,0xfc,0x52,0x5e,0xfc,0x2e,0x39,0xfd,0x03,0x1a,0xfd,0x00,0x16,0xfd,0x00,0x14,0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x00,0x0f,0xfd,
        0x47,0x49,0xb4,0x67,0x67,0x67,0xa6,0xa6,0xa6,0x7f,0x85,0xd7,0x00,0x32,0xfd,0x00,0x31,0xfd,0x00,0x2f,0xfd,0x00,0x2c,0xfd,0x00,0x2b,0xfc,0x1f,0x36,0xfd,0x46,0x55,
        0xfc,0x62,0x72,0xfd,0x77,0x86,0xfd,0x85,0x94,0xfd,0x85,0x95,0xfd,0x77,0x87,0xfd,0x62,0x70,0xfc,0x46,0x53,0xfc,0x1e,0x2c,0xfd,0x00,0x18,0xfd,0x00,0x16,0xfd,0x00,
        0x14,0xfd,0x00,0x12,0xfd,0x00,0x11,0xfd,0x3c,0x3e,0xd0,0x66,0x66,0x66,0xae,0xae,0xae,0x74,0x7b,0xdd,0x00,0x34,0xfd,0x00,0x2d,0xfe,0x00,0x2a,0xfd,0x00,0x29,0xfd,
        0x00,0x26,0xfd,0x2b,0x3c,0xfc,0x4f,0x5e,0xfc,0x69,0x7a,0xfc,0x85,0x94,0xfd,0x96,0xa4,0xfd,0x96,0xa4,0xfd,0x85,0x95,0xfd,0x69,0x79,0xfd,0x4f,0x5b,0xfc,0x2b,0x37,
        0xfd,0x00,0x19,0xfd,0x00,0x18,0xfd,0x00,0x16,0xfd,0x00,0x14,0xfd,0x00,0x12,0xfd,0x30,0x35,0xda,0x60,0x60,0x60,0xb1,0xb1,0xb1,0x74,0x7b,0xdd,0x01,0x2d,0xfd,0x05,
        0x24,0xfc,0x25,0x32,0xee,0x1b,0x2f,0xf2,0x0a,0x25,0xf9,0x2b,0x3c,0xfd,0x4e,0x5d,0xfb,0x69,0x79,0xfc,0x85,0x94,0xfd,0x96,0xa4,0xfd,0x96,0xa4,0xfd,0x85,0x95,0xfd,
        0x69,0x79,0xfd,0x4e,0x5b,0xfc,0x2b,0x38,0xfd,0x00,0x1b,0xfd,0x00,0x19,0xfd,0x00,0x18,0xfd,0x00,0x16,0xfd,0x00,0x14,0xfd,0x31,0x36,0xdb,0x62,0x62,0x62,0xab,0xab,
        0xab,0x7d,0x84,0xdd,0x01,0x27,0xfd,0x8e,0x91,0xda,0x8e,0x8e,0xce,0x6d,0x6d,0xbc,0x4d,0x4d,0xb5,0x23,0x32,0xf7,0x46,0x53,0xfd,0x61,0x71,0xfb,0x76,0x86,0xfd,0x85,
        0x94,0xfd,0x85,0x95,0xfd,0x76,0x86,0xfd,0x61,0x71,0xfd,0x45,0x52,0xfe,0x1d,0x2e,0xfd,0x00,0x1c,0xfd,0x00,0x1b,0xfd,0x00,0x19,0xfd,0x00,0x18,0xfd,0x00,0x16,0xfd,
        0x3d,0x41,0xd1,0x6c,0x6c,0x6c,0xaa,0xaa,0xb2,0x8b,0x8e,0xd5,0x25,0x36,0xfd,0xba,0xba,0xdb,0xad,0xad,0xdf,0xa3,0xa3,0xda,0x6d,0x6d,0xbe,0x34,0x39,0xd7,0x2d,0x3c,
        0xfe,0x51,0x5f,0xfc,0x61,0x70,0xfb,0x69,0x78,0xfc,0x69,0x79,0xfc,0x61,0x71,0xfd,0x50,0x5f,0xfc,0x2b,0x3b,0xfd,0x02,0x21,0xfd,0x00,0x1e,0xfd,0x00,0x1c,0xfd,0x00,
        0x1b,0xfd,0x00,0x19,0xfd,0x00,0x18,0xfd,0x4c,0x4f,0xb8,0x70,0x70,0x70,0x00,0x21,0xfe,0xa6,0xa8,0xbd,0x37,0x47,0xfc,0xbf,0xbf,0xdf,0xb9,0xb9,0xe1,0xad,0xaf,0xe1,
        0x9d,0x9d,0xda,0x6c,0x6c,0xc5,0x1b,0x2c,0xf7,0x2d,0x3c,0xfe,0x45,0x53,0xfd,0x4d,0x5d,0xfc,0x4d,0x5e,0xfc,0x44,0x54,0xfd,0x2b,0x3d,0xfe,0x1b,0x2f,0xfd,0x00,0x22,
        0xfd,0x00,0x20,0xfd,0x00,0x1e,0xfd,0x00,0x1c,0xfd,0x00,0x1b,0xfd,0x00,0x19,0xfd,0x61,0x62,0x8c,0xa7,0xa7,0xa7,0xaa,0xaa,0xaa,0xb2,0xb2,0xb2,0x66,0x6f,0xe9,0xad,
        0xaf,0xe5,0xc0,0xc0,0xeb,0xc8,0xc8,0xf9,0xa5,0xa7,0xe7,0x73,0x73,0xc8,0x2c,0x33,0xe2,0x08,0x24,0xfe,0x20,0x34,0xfd,0x29,0x3c,0xfd,0x29,0x3f,0xfc,0x1c,0x35,0xfd,
        0x01,0x28,0xfd,0x01,0x26,0xfd,0x00,0x24,0xfd,0x00,0x22,0xfd,0x00,0x20,0xfd,0x00,0x1e,0xfd,0x00,0x1c,0xfd,0x35,0x3c,0xe0,0x6d,0x6d,0x6d,0xaa,0xaa,0xaa,0xad,0xad,
        0xad,0xaf,0xaf,0xaf,0x9f,0xa1,0xc4,0x43,0x4d,0xf8,0xba,0xbc,0xea,0xd4,0xd4,0xff,0xbc,0xbe,0xf7,0x8c,0x8c,0xd6,0x58,0x5a,0xd7,0x00,0x21,0xfe,0x01,0x21,0xfe,0x04,
        0x26,0xfd,0x00,0x2b,0xfd,0x00,0x2b,0xfc,0x00,0x29,0xfd,0x00,0x28,0xfd,0x01,0x26,0xfd,0x00,0x24,0xfd,0x00,0x22,0xfd,0x00,0x20,0xfd,0x01,0x1f,0xfc,0x61,0x63,0x9c,
        0x77,0x77,0x77,0xae,0xae,0xae,0xb1,0xb1,0xb1,0x00,0x21,0xfe,0xb0,0xb0,0xb4,0x59,0x60,0xee,0x4d,0x55,0xf7,0xa6,0xa6,0xeb,0xc2,0xc2,0xf7,0x9f,0x9f,0xe7,0x51,0x52,
        0xd0,0x00,0x21,0xfe,0x00,0x21,0xfe,0x01,0x21,0xfe,0x00,0x29,0xfe,0x00,0x2c,0xfd,0x00,0x2b,0xfc,0x00,0x29,0xfd,0x00,0x28,0xfd,0x01,0x26,0xfe,0x00,0x24,0xfd,0x00,
        0x22,0xfd,0x4e,0x53,0xc8,0x73,0x74,0x74,0xb1,0xb1,0xb1,0xb1,0xb1,0xb1,0xcf,0xcf,0xcf,0xb4,0xb4,0xb4,0x00,0x21,0xfe,0xa9,0xa9,0xba,0x5f,0x6a,0xeb,0x4b,0x53,0xfd,
        0x70,0x72,0xee,0x89,0x89,0xdf,0x4f,0x51,0xdb,0x00,0x21,0xfe,0x00,0x21,0xfe,0x02,0x22,0xfe,0x00,0x2a,0xfe,0x00,0x2f,0xfd,0x00,0x2c,0xfd,0x00,0x2b,0xfc,0x00,0x29,
        0xfd,0x00,0x28,0xfd,0x01,0x26,0xfe,0x47,0x4e,0xd7,0x75,0x76,0x78,0xb5,0xb5,0xb5,0xb5,0xb5,0xb5,0xc1,0xc1,0xc1,0xef,0xef,0xef,0xc2,0xc2,0xc2,0xb8,0xb8,0xb8,0xad,
        0xad,0xc3,0xac,0xac,0xb2,0x79,0x81,0xd7,0x51,0x5c,0xfc,0x2c,0x38,0xfd,0x19,0x2a,0xfb,0x04,0x22,0xfe,0x0f,0x26,0xfe,0x0b,0x2b,0xfd,0x00,0x30,0xfe,0x00,0x31,0xfd,
        0x00,0x2f,0xfd,0x00,0x2c,0xfd,0x00,0x2b,0xfc,0x02,0x2a,0xfb,0x56,0x5c,0xc9,0x7a,0x7b,0x7d,0x5b,0x5b,0x5b,0xb8,0xb8,0xb8,0xba,0xba,0xba,0xee,0xee,0xee,0xf9,0xf9,
        0xf9,0xea,0xea,0xea,0xc0,0xc0,0xc0,0xbb,0xbb,0xbb,0x00,0x21,0xfe,0xad,0xad,0xaf,0x9a,0x9d,0xba,0x5d,0x69,0xe8,0x35,0x46,0xfc,0x2d,0x3e,0xfe,0x18,0x38,0xfd,0x01,
        0x35,0xfd,0x00,0x34,0xfd,0x00,0x32,0xfd,0x00,0x31,0xfd,0x00,0x2f,0xfc,0x46,0x52,0xe0,0x73,0x75,0xa4,0x80,0x80,0x80,0xbc,0xbc,0xbc,0xbc,0xbc,0xbc,0xbd,0xbd,0xbd,
        0xeb,0xeb,0xeb,0xf4,0xf4,0xf4,0xf1,0xf1,0xf1,0xf9,0xf9,0xf9,0xe8,0xe8,0xe8,0xc8,0xc8,0xc8,0xbf,0xbf,0xbf,0x00,0x21,0xfe,0xac,0xac,0xae,0xa8,0xa8,0xa8,0x9a,0x9b,
        0xaf,0x7f,0x84,0xc7,0x68,0x71,0xd8,0x5a,0x67,0xe0,0x57,0x64,0xe1,0x5f,0x67,0xd7,0x6e,0x74,0xc2,0x80,0x82,0x9e,0x87,0x87,0x87,0x88,0x88,0x88,0xbf,0xbf,0xbf,0xbf,
        0xbf,0xbf,0xc1,0xc1,0xc1,0xeb,0xeb,0xeb,0xf3,0xf3,0xf3,0xf9,0xf9,0xf9,0xfb,0xfb,0xfb,0xf3,0xf3,0xf3,0xf9,0xf9,0xf9,0xee,0xee,0xee,0xd5,0xd5,0xd5,0xc2,0xc2,0xc2,
        0xc3,0xc3,0xc3,0xc3,0xc3,0xc3,0xc2,0xc2,0xc2,0xa5,0xa5,0xa5,0xa1,0xa1,0xa1,0x99,0x99,0x99,0x95,0x95,0x95,0x97,0x97,0x97,0x93,0x93,0x93,0xc3,0xc3,0xc3,0xc2,0xc2,
        0xc2,0xc3,0xc3,0xc3,0xc2,0xc2,0xc2,0xcd,0xcd,0xcd,0xf0,0xf0,0xf0,0xf5,0xf5,0xf5,0xf9,0xf9,0xf9,0xf3,0xf3,0xf3
};

////////////////////////////////////////////////////////////////////////////////
static void
activate (GtkApplication* app,
          gpointer        comp) {

    GtkWidget *window = gtk_application_window_new (app);
    gtk_window_set_title (GTK_WINDOW (window), "Window");
    //gtk_window_set_default_size (GTK_WINDOW (window), 400, 200);

    main_grid = gtk_grid_new();//gtk_button_box_new (GTK_ORIENTATION_HORIZONTAL);
    gtk_container_add (GTK_CONTAINER (window), main_grid);

    GtkWidget *button = gtk_button_new_with_label ("Hello World");
    GtkWidget *button2 = gtk_button_new_with_label ("Exit");

    g_signal_connect (button, "clicked", G_CALLBACK (print_hello), comp);
    g_signal_connect_swapped (button2, "clicked", G_CALLBACK (gtk_widget_destroy), window);

    gtk_grid_attach ((GtkGrid*)main_grid, button, 1, 1, 1, 1);
    gtk_grid_attach ((GtkGrid*)main_grid, button2, 2, 1, 1, 1);



//    GtkImage * image1 = gtk_image_new_from_pixbuf ((GdkPixbuf*)pixbuf_red_on);
    image1 = gtk_image_new_from_file ("../led-red-on.png");
//
//
//    GdkPixbuf * pBuf = gtk_image_get_pixbuf (image1);
//
//    gchar *buffer;
//    gsize buffer_size;
//
//    gdk_pixbuf_save_to_buffer (pBuf,
//                               &buffer,
//                               &buffer_size,
//                               "bmp",
//                               NULL,
//                               NULL);
//
//    int i;
//    int col = 0;
//    for (i = 0; i < buffer_size; i++){
//
//        printf("0x%02x,",(unsigned char)buffer[i]);
//        col++;
//        if (col == 32){
//            printf("\n"); col = 0;
//        }
//    }

    gtk_grid_attach ((GtkGrid*)main_grid, image1, 1, 2, 1, 1);


    computer_sim_begin(comp, (GtkGrid*)main_grid);

    gtk_widget_show_all (window);
}

////////////////////////////////////////////////////////////////////////////////
int main (int argc, char **argv) {

    int status;

    computer_t *comp = malloc(sizeof(computer_t));
    memset(comp, 0, sizeof(computer_t));

    GtkApplication *app = gtk_application_new ("cpstecnologia.com.br", G_APPLICATION_FLAGS_NONE);

    g_signal_connect (app, "activate", G_CALLBACK (activate), comp);

    status = g_application_run (G_APPLICATION (app), argc, argv);

    computer_sim_end(comp);

    g_object_unref (app);

    return status;
}
